<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.store("animes", {
          list: [],
          pagination: {},
          isLoading: true,
          isError: false,
          get isEmpty() {
            return !this.list || this.list.length <= 0;
          },
          async search(filter) {
            this.isLoading = true;
            this.list = [];
            try {
              const responsePromise = await fetch(`https://api.jikan.moe/v4/anime?sfw${filter}`);
              const response = await responsePromise.json();
              console.log(response);
              this.list = response.data;
              this.pagination = response.pagination;
              // console.log(this.list);
            } catch (e) {
              console.log(e);
              this.isError = true;
            }
            this.isLoading = false;
          },
        });

        Alpine.store("modal", {
          isOpen: false,
          toggle() {
            this.isOpen = !this.isOpen;
          },
          data: null,
        });
      });

      const truncate = (text, maxChar) => {
        // trim whitespace
        const trimmedText = text.trim();

        // if text is safe, return immediately
        if (trimmedText.length <= maxChar) return trimmedText;

        // process initiation
        let currentLength = 0;
        let slicePoint = 0;
        const splittedText = trimmedText.split(" ");

        for (let i = 0; i < splittedText.length; i++) {
          // add every word length to accumulator
          currentLength += splittedText[i].length;
          // count for preceeding space too, except for the first word
          if (i > 0) currentLength += 1;
          // if accumulator exceeds max char allowed, record the word count to slice point
          if (currentLength > maxChar) {
            slicePoint = i;
            break;
          } else if (currentLength === maxChar) {
            // on rare case where final accumulator value is the same as max char allowed,
            // pass all of word to slice point
            slicePoint = splittedText.length;
          }
        }
        // slice text while aware of one word input (no space)
        const safeText = slicePoint > 0 ? splittedText.slice(0, slicePoint).join(" ") : trimmedText.slice(0, maxChar);

        // console.log(splittedText, splittedText.length);
        // console.log(trimmedText.length);
        // console.log(currentLength);
        // console.log(slicePoint);
        // console.log("safeText:", safeText);

        // add three dots to end of text to give mark of truncated text
        const finalText = safeText === text ? safeText : safeText + "...";

        return finalText;
      };
    </script>
    <title>Wibuletin</title>
  </head>
  <body x-data :class="`py-10 flex flex-col gap-3 ${$store.modal.isOpen ? 'overflow-hidden' : ''}`">
    <section
      id="search-container"
      x-data="{
        query: '',
        get queryFilter() {
          return `&q=${this.query}`
        },
        async getAnimes() { await $store.animes.search(this.queryFilter) }
        // getAnimes() {console.log(this.queryFilter)}
      }"
      class="sticky top-0 bg-white/80 backdrop-blur-md px-16 py-3 z-[99]"
    >
      <!-- search bar -->
      <div class="w-full md:w-3/4 p-1 border-2 border-slate-300 rounded-md flex bg-white">
        <input
          class="px-3 palceholder-slate-200 placeholder:italic grow border-transparent focus:outline-none trimmedtext-slate-500"
          type="text"
          placeholder="search anime title..."
          x-model="query"
          @keyup.enter="getAnimes()"
        />
        <button
          class="rounded-md p-2 bg-slate-300 hover:bg-slate-200 active:bg-slate-300 text-slate-500 hover:text-slate-400 active:text-slate-500 hover:scale-105 active:scale-100 cursor-pointer transition ease-in-out"
          @click="getAnimes()"
        >
          <!-- search icon  -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-search"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" x2="16.65" y1="21" y2="16.65"></line>
          </svg>
        </button>
      </div>
    </section>
    <section
      id="cards-container"
      x-data="{
        init: async () => await $store.animes.search('order_by=start_date&start_date=2023'),
        animes: $store.animes,
      }"
      class="px-16"
    >
      <div class="flex justify-center items-center h-[50vh]" x-data x-show="animes.isLoading">
        <div class="bg-white text-black px-7 py-5 rounded-md text-2xl flex items-center">
          <!-- loading icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-loader-2 animate-spin mr-2 w-8 h-8"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
          </svg>
          <span class="leading-none">Loading...</span>
        </div>
      </div>
      <div class="flex justify-center items-center h-[50vh]" x-data x-show="animes.isError">
        <div class="bg-red-600 text-white px-7 py-5 rounded-md text-2xl flex items-center">
          <!-- warning icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-alert-circle mr-2 w-8 h-8"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" x2="12" y1="8" y2="12"></line>
            <line x1="12" x2="12.01" y1="16" y2="16"></line>
          </svg>
          <span class="leading-none">error, please check console</span>
        </div>
      </div>
      <div class="flex justify-center items-center h-[50vh]" x-data x-show="animes.isEmpty && !animes.isLoading && !animes.isError">
        <div class="bg-white text-black px-7 py-5 rounded-md text-2xl">no results.</div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <template x-for="anime in animes.list">
          <div
            class="bg-white hover:bg-slate-100 shadow-md rounded-md h-[22rem] cursor-pointer transition ease-in-out"
            @click="() => {
              $store.modal.toggle()
              $store.modal.data = anime
              // console.log($store.modal.isOpen)
            }"
            :key="anime.mal_id"
            x-data
          >
            <!-- card picture section -->
            <section x-data="{score: anime.score && ''}" class="h-2/3 rounded-t-md overflow-hidden relative">
              <!-- background image -->
              <img :src="anime.images.webp.image_url" :alt="anime.title.split(' ').join('-').toLowerCase()" class="w-full" />
              <!-- black gradient for title shadow -->
              <div class="bg-gradient-to-t from-black via-transparent via-60% absolute top-0 left-0 right-0 bottom-0 z-40"></div>
              <!-- title -->
              <span x-text="truncate(anime.title, 40)" class="absolute bottom-4 left-4 right-4 text-white text-lg font-semibold z-50"></span>
            </section>
            <!-- card footer section -->
            <section class="relative h-1/3">
              <!-- score -->
              <span
                x-data="{score: anime.score !== null ? anime.score.toFixed(2) : 'N/A'}"
                :class="`absolute -right-1 -top-5 flex p-1 rounded-l-md text-white z-50 ${
                  score >= 7.5 ? 'bg-green-600' :
                  score >= 5.0 ? 'bg-yellow-500' :
                  score >= 2.5 ? 'bg-red-600' : 'bg-slate-700'
                }`"
              >
                <!-- star icon -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-star fill-white mr-1"
                >
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                <!-- score text -->
                <span x-text="score">test</span>
              </span>
              <!-- episodes -->
              <span
                class="absolute top-3 left-3 text-slate-600 italic"
                x-data="{ status: anime.status, episodes: anime.episodes ?? '??' }"
                x-text="`${episodes}/${['Not yet aired', 'Currently Airing'].includes(status) ? '??' : episodes} Episodes`"
              ></span>
              <!-- genres -->
              <span
                class="absolute flex flex-wrap gap-1 bottom-3 left-3 right-3"
                x-data="{
                  genre: anime.genres ? anime.genres[0] : null,
                  theme: anime.themes ? anime.themes[0] : null,
                  demographic: anime.demographics ? anime.demographics[0] : null
                }"
              >
                <span class="py-1 px-2 bg-slate-300 text-sm text-slate-700 rounded-md" x-show="genre" x-text="`${genre ? genre.name : ''}`"></span>
                <span class="py-1 px-2 bg-slate-300 text-sm text-slate-700 rounded-md" x-show="theme" x-text="`${theme ? theme.name : ''}`"></span>
                <span class="py-1 px-2 bg-slate-300 text-sm text-slate-700 rounded-md" x-show="demographic" x-text="`${demographic ? demographic.name : ''}`"></span>
              </span>
            </section>
          </div>
        </template>
      </div>
    </section>
    <section
      id="modal-container"
      class="fixed inset-0 z-[100] overflow-y-auto flex items-center justify-center min-h-screen px-4 text-center sm:p-5"
      x-data="{modal: $store.modal}"
      x-show="modal.isOpen"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <!-- modal dialog shadow -->
      <div
        x-cloak
        @click="modal.toggle()"
        x-show="modal.isOpen"
        x-transition:enter="transition ease-out duration-300 transform"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200 transform"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 transition-opacity bg-gray-500/80"
        aria-hidden="true"
      ></div>
      <!-- modal dialog -->
      <div
        x-cloak
        x-show="modal.isOpen"
        x-transition:enter="transition ease-out duration-300 transform"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="transition ease-in duration-200 transform"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="flex relative flex-col sm:flex-row gap-2 max-h-[95vh] sm:max-h-[85vh] w-full max-w-4xl p-8 overflow-hidden text-left transition-all transform bg-white rounded-lg shadow-xl"
      >
        <div
          @click="modal.toggle()"
          class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 active:bg-red-600 text-white hover:scale-105 active:scale-100 hover:cursor-pointer transition ease-in-out p-3 rounded-md"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-x"
          >
            <line x1="18" x2="6" y1="6" y2="18"></line>
            <line x1="6" x2="18" y1="6" y2="18"></line>
          </svg>
        </div>
        <div class="flex justify-center h-2/5 sm:h-full sm:w-2/5 overflow-clip">
          <img
            class="object-cover object-top"
            :src="modal.data ? modal.data.images.webp.large_image_url : ''"
            :alt="modal.data && modal.data.title.split(' ').join('-').toLowerCase()"
          />
        </div>
        <div class="pr-3 w-full flex flex-col gap-2">
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Name</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span x-text="modal.data && modal.data.title"></span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Year</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span x-text="modal.data && (modal.data.year ?? 'N/A')"></span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Genres</span>
            <span class="col-span-5 flex gap-1">
              :
              <template x-for="genre in (modal.data && (modal.data.genres ?? [])) ">
                <span class="py-1 px-2 bg-slate-300 text-slate-700 text-base rounded-md" x-text="genre.name"></span>
              </template>
              <span x-show="(modal.data && (modal.data.genres.length === 0))">N/A</span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Themes</span>
            <span class="col-span-5 flex gap-1">
              :
              <template x-for="theme in (modal.data && (modal.data.themes ?? [])) ">
                <span class="py-1 px-2 bg-slate-300 text-slate-700 text-base rounded-md" x-text="theme.name"></span>
              </template>
              <span x-show="(modal.data && (modal.data.themes.length === 0))">N/A</span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Demographics</span>
            <span class="col-span-5 flex gap-1">
              :
              <template x-for="demographic in (modal.data && (modal.data.demographics ?? [])) ">
                <span class="py-1 px-2 bg-slate-300 text-slate-700 text-base rounded-md" x-text="demographic.name"></span>
              </template>
              <span x-show="(modal.data && (modal.data.demographics.length === 0))">N/A</span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Score</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span x-text="modal.data && (modal.data.score ?? 'N/A')"></span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Status</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span x-text="modal.data && (modal.data.status ?? 'N/A')"></span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Episodes</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span x-text="modal.data && (modal.data.episodes ?? 'N/A')"></span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Duration</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span x-text="modal.data && (modal.data.duration ?? 'N/A')"></span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Studios</span>
            <span class="col-span-5 flex gap-1">
              :
              <template x-for="studio in (modal.data && (modal.data.studios ?? [])) ">
                <span class="py-1 px-2 bg-slate-300 text-slate-700 text-base rounded-md" x-text="studio.name"></span>
              </template>
              <span x-show="(modal.data && (modal.data.studios.length === 0))">N/A</span>
            </span>
          </div>
          <div class="grid grid-cols-7">
            <span class="col-span-2 font-bold">Synopsis</span>
            <span class="col-span-5 flex gap-1"
              >:
              <span class="max-h-32 overflow-y-auto" x-html="modal.data && (modal.data.synopsis ?? 'N/A')"></span>
            </span>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const items = [];
      for (let i = 0; i < 10; i++) {
        const chromosoms = [];

        for (let j = 0; j < 10; j++) {
          chromosoms.push({
            id: [i, j],
            value: Math.round(Math.random() * 100),
          });
        }

        items.push({ id: i, chromosoms });
      }

      console.log("before swap :", items);

      const newItems = [];

      items.forEach((item) => {
        const newChromosoms = [];
        item.chromosoms.forEach((chromosom) => {
          newChromosoms.push({ ...chromosom });
        });
        newItems.push({
          id: item.id,
          chromosoms: [...newChromosoms],
        });
      });

      newItems.map((newItem) => {
        [newItem.chromosoms[2], newItem.chromosoms[4]] = [{ ...newItem.chromosoms[4] }, { ...newItem.chromosoms[2] }];
        return newItem;
      });

      console.log("after swap :", newItems);
    </script>
  </body>
</html> -->
